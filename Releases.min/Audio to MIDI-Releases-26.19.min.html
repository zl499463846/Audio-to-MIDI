<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport"content="width=device-width, initial-scale=1.0"><title>éŸ³é¢‘è½¬MIDI/Audio to MIDI</title><style>*{margin:0;padding:0;box-sizing:border-box}body{background:#0b0f1a;color:#e0e0e0;font-family:'Segoe UI',system-ui;padding:20px}.container{max-width:1000px;margin:0 auto}h1{color:#ffb347;font-size:2.5rem;margin-bottom:5px}.subtitle{color:#a0c0ff;margin-bottom:30px;padding-left:20px;border-left:4px solid#ffb347}.upload-area{background:#1e2437;border:3px dashed#4f6f8f;border-radius:30px;padding:40px;text-align:center;cursor:pointer;transition:0.2s;margin-bottom:20px}.upload-area:hover{border-color:#ffb347;background:#252e45}#fileName{margin-top:15px;color:#ffb347;font-weight:bold}.flex-row{display:flex;gap:20px;align-items:center;flex-wrap:wrap}.control-item{flex:1 1 200px}.control-item label{display:block;color:#ffb347;font-weight:bold;margin-bottom:5px}.control-item input[type=range]{width:100%}.value-display{background:#0f1422;padding:5px 10px;border-radius:8px;text-align:center;margin-top:5px}.checkbox-item{display:flex;align-items:center;gap:10px;margin:15px 0}.checkbox-item input{width:20px;height:20px;cursor:pointer}button{padding:20px 45%;font-size:1.1rem;border:none;border-radius:40px;cursor:pointer;font-weight:bold;background:#4a9eff;color:white;margin:5px;transition:0.1s}button.success{background:#5fb85f}button:active{transform:translateY(2px);opacity:0.9}button:disabled{opacity:0.5;cursor:not-allowed}.progress-bar{background:#1e2437;height:20px;border-radius:10px;margin:20px 0;overflow:hidden}.progress-fill{height:100%;width:0%;background:linear-gradient(90deg,#4a9eff,#ffb347);transition:width 0.2s}.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin:20px 0}.stat-card{background:#1e2437;border-radius:12px;padding:15px;text-align:center}.stat-number{font-size:2rem;font-weight:bold;color:#ffb347}.warning{background:#332211;color:#ffcc99;padding:15px;border-radius:15px;margin:20px 0}.note-list{max-height:200px;overflow-y:auto;display:flex;flex-wrap:wrap;gap:5px;background:#1e2437;border-radius:10px;padding:10px;margin-top:10px}.note-tag{background:#0f1422;padding:5px 10px;border-radius:15px;font-size:0.9rem;border-left:3px solid#ffb347}</style></head><body><div class="container"><h1>éŸ³é¢‘ è½¬ MIDI</h1><div class="subtitle">ZLSR(zl499463846) 2026 å…¬ç›Šå¼€æºé¡¹ç›®ï¼Œéšæ„å•†ç”¨ï¼Œä¹Ÿå¯ä»¥è¯´æ—¶è‡ªå·±åšçš„ï¼Œæ¯•ç«Ÿè¿™ä¸ªé¡¹ç›®æŒºå®ç”¨çš„ï¼Œæ¬¢è¿ä¼ æ’­ï¼</div><div class="upload-area"id="dropZone"><div style="font-size: 48px;">ğŸ“‚</div><h3>ç‚¹å‡»æˆ–æ‹–æ”¾éŸ³é¢‘æ–‡ä»¶</h3><input type="file"id="fileInput"accept="audio/*"style="display: none;"><div id="fileName"></div></div><div class="panel"><div class="flex-row"><div class="control-item"><label>æœ€ä½MIDIéŸ³ç¬¦</label><input type="range"id="minNote"min="0"max="126"value="0"step="1"><div class="value-display"id="minNoteVal">0</div></div><div class="control-item"><label>æœ€é«˜MIDIéŸ³ç¬¦</label><input type="range"id="maxNote"min="1"max="127"value="127"step="1"><div class="value-display"id="maxNoteVal">127</div></div><div class="control-item"><label>FFTé‡å å› å­</label><select id="fftOverlap"style="width:100%; padding:20px; background:#0f1422; color:white; border:1px solid #4a5a7a; border-radius:8px; font-size:16px;"><option value="2">2x (å¿«é€Ÿ)</option><option value="4"selected>4x (æ¨è)</option><option value="8">8x (å¹³æ»‘)</option><option value="16">16x (æé«˜æ—¶é—´åˆ†è¾¨ç‡)</option></select></div><div class="control-item"><label>å“åº¦é˜ˆå€¼</label><input type="range"id="threshold"min="0.001"max="0.1"step="0.001"value="0.005"><div class="value-display"id="thresholdVal">0.005</div></div><div class="control-item"><label>å“åº¦ç¼©æ”¾ (0.5-2.0)</label><input type="range"id="loudnessScale"min="0.5"max="2.0"step="0.1"value="1.0"><div class="value-display"id="loudnessScaleVal">1.0</div></div><div class="control-item"><label>FFTå¤§å°</label><select id="fftSize"style="width:100%; padding:20px; background:#0f1422; color:white; border:1px solid #4a5a7a; border-radius:8px; font-size:16px;"><option value="512">512 (é¢‘ç‡ç²¾åº¦æœ€ä½,æ—¶é—´ç²¾åº¦æœ€é«˜,ä½“ç§¯æœ€å¤§)</option><option value="1024">1024 (é¢‘ç‡ç²¾åº¦è¾ƒä½,æ—¶é—´ç²¾åº¦è¾ƒé«˜,ä½“ç§¯è¾ƒå¤§)</option><option value="2048">2048 (æ—¶é—´ç²¾åº¦>é¢‘ç‡ç²¾åº¦,ä½“ç§¯å¤§ä¸€ç‚¹)</option><option value="4096"selected>4096 (å…¨é¢å¹³è¡¡,ä½“ç§¯é€‚ä¸­)</option><option value="8192">8192 (é¢‘ç‡ç²¾åº¦>æ—¶é—´ç²¾åº¦,ä½“ç§¯å°ä¸€ç‚¹)</option><option value="16384">16384 (é¢‘ç‡ç²¾åº¦è¾ƒé«˜,æ—¶é—´ç²¾åº¦è¾ƒä½,ä½“ç§¯è¾ƒå°)</option><option value="32768">32768 (é¢‘ç‡ç²¾åº¦æœ€é«˜,æ—¶é—´ç²¾åº¦æœ€ä½,ä½“ç§¯æœ€å°)</option></select></div></div><div class="checkbox-item"><input type="checkbox"id="removeEmpty"><label for="removeEmpty">[å¯å‹¾é€‰]è‡ªåŠ¨å»é™¤ç©ºç™½å¸§ (ä¸æ¨è,å®¹æ˜“è¯¯ä¼¤æ­£å¸¸éŸ³ç¬¦)</label></div><p style="color: #a0c0ff; font-size: 0.9rem;">1. FFTé‡å å› å­ï¼šè¶Šå¤§éŸ³è´¨è¶Šé«˜ï¼Œå¤„ç†æ—¶é—´ä¼šæ›´é•¿</p><p style="color: #a0c0ff; font-size: 0.9rem;">2. å“åº¦é˜ˆå€¼ï¼šé˜ˆå€¼è¶Šå°ï¼Œç”Ÿæˆçš„MIDIä½“ç§¯è¶Šå¤§ï¼ŒéŸ³è´¨è¶Šé«˜</p><p style="color: #a0c0ff; font-size: 0.9rem;">3. å“åº¦ç¼©æ”¾ï¼šå½±å“ä¸å¤§ï¼Œé»˜è®¤å°±å¥½</p><p style="color: #a0c0ff; font-size: 0.9rem;">4. FFTå¤§å°ï¼šFFTè¶Šå°ï¼Œç”Ÿæˆçš„MIDIä½“ç§¯è¶Šå¤§ï¼Œä¸º4096æ—¶éŸ³è´¨æœ€é«˜</p><p style="color: #a0c0ff; font-size: 0.9rem;">5. è‡ªåŠ¨å»é™¤ç©ºç™½å¸§å¼€å¯åï¼Œæ²¡æœ‰ä»»ä½•éŸ³ç¬¦çš„å¸§å°†è¢«åˆ é™¤ï¼Œå‰©ä½™å¸§çš„æ—¶é—´è½´é‡æ–°è®¡ç®—ï¼Œæ€»æ—¶é•¿ç­‰äºåŸéŸ³é¢‘ï¼Œæ¶ˆé™¤é™éŸ³åœé¡¿</p><p style="color: #ee8855; font-size: 0.9rem;">6. è¯·ä¸è¦åœ¨å¤„ç†æ—¶å¤šæ¬¡ç‚¹å‡»è½¬æ¢æŒ‰é’®ï¼Œå¦åˆ™å¯èƒ½é—ªé€€</p><p style="color: #ee8855; font-size: 0.9rem;">7. è‹¥é¡µé¢å¡é¡¿æˆ–æ— å“åº”ï¼Œè¯·å…ˆä¸è¦å…³é—­ï¼Œè€å¿ƒç­‰å¾…ï¼ŒFFTç®—æ³•å¾ˆåƒCPUï¼Œæ…¢å·¥å‡ºç»†æ´»å˜›</p></div><div class="panel"><div class="flex-row"style="justify-content: center;"><button id="dynamicBtn"class="success"disabled style="width:100%; margin:20px 0;">å¼€å§‹è½¬æ¢</button></div><div class="progress-bar"><div class="progress-fill"id="progressFill"></div></div><div id="progressText"style="text-align:center; margin-top:10px;">ç­‰å¾…ä¸Šä¼ æ–‡ä»¶...</div></div><div class="stats"><div class="stat-card"><div class="stat-number"id="statFrames">0</div><div class="stat-label">åŸå§‹å¸§æ•°</div></div><div class="stat-card"><div class="stat-number"id="statBins">0</div><div class="stat-label">é¢‘ç‡é€šé“</div></div><div class="stat-card"><div class="stat-number"id="statAvgNotes">0</div><div class="stat-label">å¹³å‡éŸ³ç¬¦/å¸§</div></div><div class="stat-card"><div class="stat-number"id="statTotalNotes">0</div><div class="stat-label">æ€»éŸ³ç¬¦æ•°</div></div></div><div class="control-item"><label style="font-size:30px; text-align: center;">MIDIå¤„ç†æ¨¡å¼ï¼ˆè°ƒæ•´æ­¤é¡¹ä¸éœ€è¦é‡æ–°è½¬æ¢ï¼‰</label><select id="midiMode"style="width:100%; padding:20px; background:#0f1422; color:white; border:1px solid #4a5a7a; border-radius:8px; font-size:16px; text-align: center;"><option value="normal"selected>é«˜éŸ³è´¨ç®—æ³•ï¼ˆå¯¹æ’­æ”¾å™¨è¦æ±‚æé«˜ï¼Œæ–‡ä»¶å¤§ï¼Œæ’­æ”¾å™¨å¾—å½“çš„è¯éŸ³è´¨æœ€é«˜ï¼‰</option><option value="overlap">å¹³è¡¡ä¿®å¤ç®—æ³•ï¼ˆç‰ºç‰²å°éƒ¨åˆ†éŸ³è´¨ï¼Œæ–‡ä»¶å¤§ï¼Œå…¼å®¹æ€§ä¸€èˆ¬ï¼ŒéŸ³è´¨ç•¥å·®äºé«˜éŸ³è´¨ç®—æ³•ï¼‰</option><option value="traditional">ä¼ ç»Ÿå¤„ç†ç®—æ³•(æ™®é€šçš„Audio to Midiç½‘ç«™çš„è½¬æ¢ç­–ç•¥ï¼Œæ–‡ä»¶å°ï¼Œé€šç”¨æ€§é«˜)</option></select></div><div id="previewPlayer"style="background: #1e2437; border-radius: 20px; padding: 20px; margin: 20px 0; display: none;"><div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;"><button id="previewPlayBtn"style="background: #5fb85f; color: white; border: none; border-radius: 30px; padding: 12px 25px; font-size: 1.1rem; cursor: pointer; font-weight: bold; transition: 0.1s;">â–¶ï¸ é¢„è§ˆMIDI</button><button id="previewStopBtn"style="background: #ff8c5a; color: white; border: none; border-radius: 30px; padding: 12px 25px; font-size: 1.1rem; cursor: pointer; font-weight: bold;">ğŸ—˜ åˆ·æ–°</button><div style="flex: 1; min-width: 200px;"><input type="range"id="previewProgress"min="0"max="1000"value="0"style="width: 100%;"><div style="display: flex; justify-content: space-between; margin-top: 5px;"><span id="previewCurrentTime">0:00</span><span id="previewTotalTime">0:00</span></div></div></div></div><button id="downloadBtn"disabled style="width:100%; margin:20px 0;">ä¿å­˜(.mid)</button><div class="panel"><h4 style="color:#ffb347;">æå–çš„éŸ³ç¬¦é¢„è§ˆ</h4><div class="note-list"id="noteList">æš‚æ— éŸ³ç¬¦</div></div><div class="warning"id="info">è¯·ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶!</div></div><p style="color: #aaaaee;text-align: center;">æœ‰BUGä¸è¦æ¥éª‚æˆ‘ï¼Œè¿™ä¸ªç¨‹åºæ˜¯æˆ‘é—²ç€æ²¡äº‹åšçå†™çš„ï¼Œè§è°…...</p><script>!function(){var e=document.getElementById("dropZone");const t=document.getElementById("fileInput"),I=document.getElementById("fileName"),S=document.getElementById("dynamicBtn"),P=document.getElementById("downloadBtn"),w=document.getElementById("progressFill"),B=document.getElementById("progressText"),V=document.getElementById("info"),W=document.getElementById("noteList"),Y=document.getElementById("removeEmpty"),G=document.getElementById("minNote"),X=document.getElementById("maxNote"),b=document.getElementById("minNoteVal"),k=document.getElementById("maxNoteVal"),j=document.getElementById("threshold"),L=document.getElementById("thresholdVal"),ee=document.getElementById("fftSize"),q=document.getElementById("statFrames"),te=document.getElementById("statBins"),_=document.getElementById("statAvgNotes"),z=document.getElementById("statTotalNotes"),Z=document.getElementById("loudnessScale"),n=document.getElementById("loudnessScaleVal"),ne=document.getElementById("fftOverlap"),a=document.getElementById("midiMode");function r(){b.innerText=G.value,k.innerText=X.value,L.innerText=parseFloat(j.value).toFixed(3)}Z.addEventListener("input",()=>{n.innerText=parseFloat(Z.value).toFixed(1)}),n.innerText=Z.value,S.innerText="ç­‰å¾…ä¸Šä¼ ",S.disabled=!0,G.addEventListener("input",r),X.addEventListener("input",r),j.addEventListener("input",r),r();let i=null,J=null,o="audio",K=[];function F(e){var t;e&&e[0]&&(e=e[0],o=e.name.replace(/\.[^/.]+$/,""),I.innerText="å·²é€‰æ‹©: "+e.name,(t=new FileReader).onload=e=>{(i=i||new(window.AudioContext||window.webkitAudioContext)).decodeAudioData(e.target.result,e=>{J=e,Q(5,"è½½å…¥æ–‡ä»¶æˆåŠŸ!"),S.disabled=!1,S.innerText="å¼€å§‹è½¬æ¢",P.disabled=!0,V.innerHTML="âœ” éŸ³é¢‘åŠ è½½æˆåŠŸ"},e=>{V.innerHTML="âŒ è§£ç å¤±è´¥: "+e,S.innerText="æ–‡ä»¶è§£ç å¤±è´¥",Q(0,"ä»€ä¹ˆé¬¼?")})},t.readAsArrayBuffer(e))}function Q(e,t){w.style.width=e+"%",B.innerText=t}function y(e){var t=[];let n=e;for(t.unshift(127&n),n>>=7;0<n;)t.unshift(127&n|128),n>>=7;return t}function A(e){e&&0!==e.length||(e=[{midi:60,start:0,end:1,velocity:100}]);var t=[],n=(t.push(0,255,81,3,7,161,32),t.push(0,255,3,5,65,117,100,105,111),t.push(0,255,47,0),[]),r=[],e=[...e].sort((e,t)=>e.start-t.start),a=[];let i=[],o=e[0]?.start;for(const g of e)Math.abs(g.start-o)<1e-4?i.push(g):(a.push(i),i=[g],o=g.start);0<i.length&&a.push(i);let l=0,d=0;for(let t=0;t<a.length;t++){var s=a[t],u=s[0].start,c=Math.floor(960*u),m=t%2==0,h=Math.max(...s.map(e=>e.end)),h=Math.floor(960*h)-c,v=2*h;if(m){m=c-l;n.push(...y(0<=m?m:0));for(let e=0;e<s.length;e++)0<e&&n.push(0),n.push(144,s[e].midi,s[e].velocity);if(0<v){n.push(...y(v));for(let e=0;e<s.length;e++)0<e&&n.push(0),n.push(128,s[e].midi,64);l=c+v}}else{let e=480;e=t<a.length-1?(m=a[t+1][0].start,Math.floor(960*(m-u))):h,e=Math.max(1,e);m=Math.floor(e/2),u=c+m,h=u-d;r.push(...y(0<=h?h:0));for(let e=0;e<s.length;e++)0<e&&r.push(0),r.push(144,s[e].midi,s[e].velocity);if(0<v){r.push(...y(v));for(let e=0;e<s.length;e++)0<e&&r.push(0),r.push(128,s[e].midi,64);d=u+v}}}function f(e){var t=e.length;return[77,84,114,107,t>>24&255,t>>16&255,t>>8&255,255&t,...e]}n.push(0,255,47,0),r.push(0,255,47,0);var e=f(t),t=f(n),p=f(r),e=[...[77,84,104,100,0,0,0,6,0,1,0,3,1,224],...e,...t,...p];return new Blob([new Uint8Array(e)],{type:"audio/midi"})}function C(e){e&&0!==e.length||(e=[{midi:60,start:0,end:1,velocity:100}]);var t,n,r=[],a=(r.push(0,255,81,3,7,161,32),r.push(0,255,3,5,65,117,100,105,111),r.push(0,255,47,0),[]);let i=0;const o=new Map;e.forEach(e=>{var t=e.start.toFixed(6);o.has(t)||o.set(t,[]),o.get(t).push(e)});for([t,n]of Array.from(o.entries()).sort((e,t)=>parseFloat(e[0])-parseFloat(t[0]))){var l=Math.floor(960*parseFloat(t));a.push(...y(l-i)),i=l;for(let e=0;e<n.length;e++)0<e&&a.push(0),a.push(144,n[e].midi,n[e].velocity);var d=Math.max(...n.map(e=>e.end)),d=Math.floor(960*d),l=d-l;if(0<l){a.push(...y(l));for(let e=0;e<n.length;e++)0<e&&a.push(0),a.push(128,n[e].midi,64);i=d}}function s(e){var t=e.length;return[77,84,114,107,t>>24&255,t>>16&255,t>>8&255,255&t,...e]}a.push(0,255,47,0);e=s(r),r=s(a),e=[...[77,84,104,100,0,0,0,6,0,1,0,2,1,224],...e,...r];return new Blob([new Uint8Array(e)],{type:"audio/midi"})}function N(e){e&&0!==e.length||(e=[{midi:60,start:0,end:1,velocity:100}]);const t=new Map;e.forEach(e=>{t.has(e.midi)||t.set(e.midi,[]),t.get(e.midi).push({start:e.start,end:e.end,velocity:e.velocity||100})});var i=[];for(let[e,a]of t.entries()){a.sort((e,t)=>e.start-t.start);let r=0;for(;r<a.length;){let t=r;for(;t+1<a.length&&a[t+1].start-a[t].end<=.01;)t++;let n=0;for(let e=r;e<=t;e++)n+=a[e].velocity;var o=Math.round(n/(t-r+1)),o=Math.min(127,Math.max(1,o));i.push({midi:e,start:a[r].start,end:a[t].end,velocity:o}),r=t+1}}0===i.length&&i.push({midi:60,start:0,end:1,velocity:100});const n=[];i.forEach(e=>{n.push({time:e.start,type:"on",midi:e.midi,vel:e.velocity}),n.push({time:e.end,type:"off",midi:e.midi,vel:64})}),n.sort((e,t)=>e.time-t.time);var e=[],r=(e.push(0,255,81,3,7,161,32),e.push(0,255,3,8,78,111,118,111,108,117,109,101),e.push(0,255,47,0),[]);let a=0;for(const c of n){var l=Math.floor(960*c.time),d=l-a;d<0||(r.push(...function(e){var t=[];let n=e;for(t.unshift(127&n),n>>=7;0<n;)t.unshift(127&n|128),n>>=7;return t}(d)),r.push("on"===c.type?144:128,c.midi,c.vel),a=l)}function s(e){var t=e.length;return[77,84,114,107,t>>24&255,t>>16&255,t>>8&255,255&t,...e]}r.push(0,255,47,0);var e=s(e),u=s(r),e=[...[77,84,104,100,0,0,0,6,0,1,0,2,1,224],...e,...u];return new Blob([new Uint8Array(e)],{type:"audio/midi"})}e.addEventListener("click",()=>t.click()),t.addEventListener("change",e=>F(e.target.files)),e.addEventListener("dragover",e=>e.preventDefault()),e.addEventListener("drop",e=>{e.preventDefault(),F(e.dataTransfer.files)}),S.addEventListener("click",function(){S.disabled=!0,S.innerText="è½¬æ¢ä¸­...",Q(30,"è®¡ç®—FFT..."),J?setTimeout(()=>{if(J){var n=J,r=n.sampleRate,a=n.getChannelData(0),n=n.duration,i=parseInt(G.value),o=parseInt(X.value),O=parseFloat(j.value),l=parseInt(ee.value),d=parseInt(ne.value),s=Math.floor(l/d),d=Y.checked,u=Math.floor((a.length-l)/s)+1,c=l/2+1,m=(q.innerText=u,te.innerText=c,new Float64Array(l));for(let e=0;e<l;e++)m[e]=.5-.5*Math.cos(2*Math.PI*e/(l-1));var h=[];for(let e=0;e<u;e++){var v=e*s,f=new Float64Array(l),p=new Float64Array(l);for(let e=0;e<l;e++)v+e<a.length&&(f[e]=a[v+e]*m[e]);k=b=B=w=I=x=M=E=T=y=g=void 0;var g=f,y=p,T=(S.disabled=!0,S.innerText="è½¬æ¢ä¸­...",g.length);if(!(T<=1)){var E=Math.log2(T);for(let n=0;n<T;n++){let t=0;for(let e=0;e<E;e++)n>>e&1&&(t|=1<<E-1-e);t>n&&([g[n],g[t]]=[g[t],g[n]],[y[n],y[t]]=[y[t],y[n]])}for(let e=2;e<=T;e<<=1){var M=e/2,x=-2*Math.PI/e;for(let t=0;t<T;t+=e)for(let e=0;e<M;e++){var I=x*e,w=Math.cos(I),I=Math.sin(I),B=g[t+e],b=y[t+e],k=g[t+e+M]*w-y[t+e+M]*I,I=g[t+e+M]*I+y[t+e+M]*w;g[t+e]=B+k,y[t+e]=b+I,g[t+e+M]=B-k,y[t+e+M]=b-I}}}var L=[];let t=0;for(let e=0;e<c;e++){var F=Math.sqrt(f[e]*f[e]+p[e]*p[e])/l;L.push(F),F>t&&(t=F)}var A,C,N=[];for(let e=1;e<c-1;e++)L[e]>O&&L[e]>L[e-1]&&L[e]>L[e+1]&&((A=e*r/l)<20||2e4<A||(A=Math.round(12*Math.log2(A/440)+69))<i||o<A||(C=parseFloat(Z.value),C=Math.floor(L[e]/t*100*C+20),C=Math.min(127,Math.max(20,C)),N.push({midi:A,vel:C})));h.push(N),e%20==0&&Q(10+Math.floor(e/u*70),`åˆ†æå¸§${e}/${u} (${N.length} éŸ³)`)}let t=h,e=0;d&&(t=h.filter(e=>0<e.length),e=h.length-t.length);d=n,n=t.length;if(0===n)S.disabled=!1,S.innerText="å¼€å§‹è½¬æ¢",K=[],_.innerText="0",z.innerText="0",R=[],S.disabled=!1,S.innerText="å¼€å§‹è½¬æ¢",R=R.slice(0,50).map(e=>{var t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][(t=e.midi)%12]+(Math.floor(t/12)-1);return`<span class="note-tag"title="å¼€å§‹:${e.start.toFixed(2)}s åŠ›åº¦:${e.velocity}">${t}(${e.velocity})</span>`}).join(""),W.innerHTML=R||"æ— éŸ³ç¬¦",m.currentNotes=K,Q(100,"å®Œæˆï¼ˆæ— éŸ³ç¬¦ï¼‰"),P.disabled=!0,V.innerHTML="âš ï¸ æ‰€æœ‰å¸§å‡ä¸ºç©ºç™½ï¼Œè¯·é™ä½é˜ˆå€¼ã€‚";else{var D=d/n;const $=[];for(let e=0;e<t.length;e++){const H=e*D,U=(e+1)*D;t[e].forEach(e=>{$.push({midi:e.midi,start:H,end:U,velocity:e.vel})})}var R=((K=$).length/n).toFixed(1);_.innerText=R,z.innerText=$.length,q.innerText=""+u,Q(100,"å®Œæˆï¼"),m.currentNotes=K,P.disabled=!1,V.innerHTML=`âœ…è½¬æ¢å®Œæˆï¼Œå…±${$.length}ä¸ªéŸ³ç¬¦ï¼Œå¹³å‡æ¯å¸§${R}ä¸ªï¼Œå·²å»é™¤${e}ç©ºç™½å¸§ã€‚`,S.disabled=!1,S.innerText="å¼€å§‹è½¬æ¢"}}else V.innerHTML="è¯·å…ˆä¸Šä¼ éŸ³é¢‘",S.disabled=!1,S.innerText="å¼€å§‹è½¬æ¢"},50):V.innerHTML="è¯·å…ˆä¸Šä¼ éŸ³é¢‘"}),P.addEventListener("click",()=>{if(Q(100,"ä¿å­˜MIDIæ–‡ä»¶..."),0===K.length)V.innerHTML="æ²¡æœ‰éŸ³ç¬¦æ•°æ®";else{let e;e=("overlap"===a.value?A:"traditional"===a.value?N:C)(K,J&&J.duration),currentMidiBlob=e;var t="overlap"===a.value?"-OVE":"traditional"===a.value?"-TRA":"",n=URL.createObjectURL(e),r=document.createElement("a");r.href=n,r.download=o+"-FFT"+t+".mid",r.click(),URL.revokeObjectURL(n)}});let l=null,d=!1,s=0,u=0,c=null,m=[],h=!1,v=[],f=0;const p=document.getElementById("previewPlayBtn");e=document.getElementById("previewStopBtn");const g=document.getElementById("previewProgress"),T=document.getElementById("previewCurrentTime"),D=document.getElementById("previewTotalTime");function E(e){return Math.floor(e/60)+":"+Math.floor(e%60).toString().padStart(2,"0")}function M(){v.forEach(e=>clearTimeout(e)),v=[]}async function R(){c&&clearInterval(c),M(),l&&(await l.close(),l=null),d=!1,p.innerText="â–¶ï¸ é¢„è§ˆMIDI",p.style.backgroundColor="#5fb85f",g.value=0,T.innerText="0:00",D.innerText="0:00"}function $(){var e;d&&l&&!h&&(e=l.currentTime-s,T.innerText=E(e),g.value=1e3*e)}async function H(){if(K){let e;e=("overlap"===a.value?A:"traditional"===a.value?N:C)(K,J&&J.duration);var t=currentMidiBlob=e;try{M();var{notes:n,duration:r}=function(e){var r=new Uint8Array(e),a=[];let i=480,o=5e5,l=(14<=r.length&&77===r[0]&&84===r[1]&&104===r[2]&&100===r[3]&&(i=r[12]<<8|r[13]),-1),d=0;for(let e=14;e<r.length-8;e++)if(77===r[e]&&84===r[e+1]&&114===r[e+2]&&107===r[e+3]){var s=r[e+4]<<24|r[e+5]<<16|r[e+6]<<8|r[e+7],u=e+8+s;let t=e+8;var c={};let n=0;for(;t<u;){let e=0;if(t<u&&128&(e=r[t++])&&(e&=127,t<u)&&(e=e<<7|127&r[t++]),n+=e,t>=u)break;var m,h,v,f=r[t++];255===f&&t<u&&81===r[t]?++t<u&&3===r[t++]&&t+2<u&&(o=r[t]<<16|r[t+1]<<8|r[t+2],t+=3):144<=f&&f<=159&&t+1<u?(v=(15&f)+"_"+(h=r[t++]),0<(m=r[t++])?(c[v]={tick:n,note:h,velocity:m},(-1===l||n<l)&&(l=n)):c[v]&&(a.push({noteNumber:(h=c[v]).note,startTick:h.tick,endTick:n,velocity:h.velocity}),n>d&&(d=n),delete c[v])):128<=f&&f<=143&&t+1<u&&(m=r[t++],r[t++],c[h=(15&f)+"_"+m])&&(a.push({noteNumber:m,startTick:(v=c[h]).tick,endTick:n,velocity:v.velocity}),n>d&&(d=n),delete c[h])}for(const g in c){var p=c[g];a.push({noteNumber:p.note,startTick:p.tick,endTick:d+i,velocity:p.velocity})}e=u-1}if(0===a.length)return{notes:[],duration:0};const t=o/1e6/i;return e=d*t,{notes:a.map(e=>({time:e.startTick*t,duration:(e.endTick-e.startTick)*t,noteNumber:e.noteNumber,velocity:(e.velocity||100)/127})).sort((e,t)=>e.time-t.time),duration:e}}(await t.arrayBuffer());0===n.length?alert("MIDI æ–‡ä»¶ä¸­æ²¡æœ‰å¯æ’­æ”¾çš„éŸ³ç¬¦"):(f=r,m=n,p.innerText="â¹ï¸ åœæ­¢",p.style.backgroundColor="#ff4444",d=!0,"suspended"===(l=l||new(window.AudioContext||window.webkitAudioContext)).state&&await l.resume(),D.innerText=E(r),g.max=1e3*r,g.value=0,s=l.currentTime,x(u=0),c=setInterval($,50))}catch(e){console.error("è§£æ MIDI å¤±è´¥:",e),alert("é¢„è§ˆå¤±è´¥ï¼šæ— æ³•è§£æç”Ÿæˆçš„ MIDI æ–‡ä»¶")}}else alert("æ²¡æœ‰éŸ³ç¬¦æ•°æ®ï¼Œè¯·å…ˆè½¬æ¢")}function x(t){M(),m.forEach(r=>{var e;r.time>=t&&(e=setTimeout(()=>{if(d&&l)try{var e=l.createGain(),t=l.createOscillator(),n=(t.type="sine",t.frequency.value=440*Math.pow(2,(r.noteNumber-69)/12),e.gain.value=.15*r.velocity,t.connect(e),e.connect(l.destination),l.currentTime);t.start(n),t.stop(n+r.duration)}catch(e){console.warn("é¢„è§ˆéŸ³ç¬¦æ’­æ”¾å¤±è´¥:",e)}},1e3*(r.time-t)),v.push(e))})}function $(){var e;d&&l&&!h&&((e=l.currentTime-s)>=f?R():(T.innerText=E(e),g.value=1e3*e))}document.getElementById("previewPlayer").style.display="block",g.addEventListener("mousedown",()=>{h=!0}),g.addEventListener("mousemove",e=>{var t;h&&f&&(t=g.getBoundingClientRect(),e=(e.clientX-t.left)/t.width,t=(e=Math.max(0,Math.min(1,e)))*f,T.innerText=E(t),g.value=1e3*t)}),g.addEventListener("mouseup",async e=>{var t;h&&l&&m.length&&(t=g.getBoundingClientRect(),e=(e.clientX-t.left)/t.width,t=(e=Math.max(0,Math.min(1,e)))*f,M(),T.innerText=E(t),g.value=1e3*t,u=(d&&(x(t),s=l.currentTime-t),t),h=!1)}),g.addEventListener("touchstart",()=>{h=!0}),g.addEventListener("touchmove",e=>{var t;h&&f&&(e.preventDefault(),e=e.touches[0],t=g.getBoundingClientRect(),e=(e.clientX-t.left)/t.width,t=(e=Math.max(0,Math.min(1,e)))*f,T.innerText=E(t),g.value=1e3*t)}),g.addEventListener("touchend",async e=>{var t;h&&l&&m.length&&(e=e.changedTouches[0],t=g.getBoundingClientRect(),e=(e.clientX-t.left)/t.width,t=(e=Math.max(0,Math.min(1,e)))*f,M(),T.innerText=E(t),g.value=1e3*t,u=(d&&(x(t),s=l.currentTime-t),t),h=!1)}),p.addEventListener("click",async()=>{var e,t;d?l&&(await l.suspend(),d=!1,p.innerText="â–¶ï¸ æ’­æ”¾",p.style.backgroundColor="#5fb85f",u=l.currentTime-s,clearInterval(c)):l&&m.length?(e=performance.now()/1e3,t=l.currentTime,c=(e-(u+s)<.1?(await l.resume(),d=!0,p.innerText="â¹ï¸ åœæ­¢",p.style.backgroundColor="#ff4444",s=t-u,x(u)):(await l.resume(),d=!0,p.innerText="â¹ï¸ åœæ­¢",p.style.backgroundColor="#ff4444",s=t-u,M(),l.currentTime,m.forEach(r=>{var e;r.time>=u&&(e=r.time-u,e=setTimeout(()=>{if(d&&l)try{var e=l.createGain(),t=l.createOscillator(),n=(t.type="sine",t.frequency.value=440*Math.pow(2,(r.noteNumber-69)/12),e.gain.value=.15*r.velocity,t.connect(e),e.connect(l.destination),l.currentTime);t.start(n),t.stop(n+r.duration)}catch(e){console.warn("é¢„è§ˆéŸ³ç¬¦æ’­æ”¾å¤±è´¥:",e)}},1e3*e),v.push(e))})),setInterval($,50))):await H()}),e.addEventListener("click",R)}();</script></body></html>